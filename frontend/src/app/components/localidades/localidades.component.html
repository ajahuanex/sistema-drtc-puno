<!-- Componente de Localidades -->
<div class="localidades-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-info">
      <h1>
        <mat-icon>place</mat-icon>
        Localidades
      </h1>
      <p>Gestión simplificada de localidades del sistema</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="abrirModalNuevaLocalidad()">
        <mat-icon>add</mat-icon>
        Nueva Localidad
      </button>
      <button mat-stroked-button (click)="recargarDatos()" [disabled]="cargando()">
        <mat-icon>refresh</mat-icon>
        Recargar
      </button>
      <button mat-stroked-button (click)="debugFiltros()" class="btn-debug">
        <mat-icon>bug_report</mat-icon>
        Debug
      </button>
    </div>
  </div>

  <!-- Información de Base de Datos -->
  <app-info-base-datos></app-info-base-datos>

  <!-- Estadísticas -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon provincias">location_city</mat-icon>
          <div class="stat-info">
            <div class="stat-number">{{ localidadesPorTipo('PROVINCIA').length }}</div>
            <div class="stat-label">Provincias</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon distritos">map</mat-icon>
          <div class="stat-info">
            <div class="stat-number">{{ localidadesPorTipo('DISTRITO').length }}</div>
            <div class="stat-label">Distritos</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon pueblos">home</mat-icon>
          <div class="stat-info">
            <div class="stat-number">{{ localidadesPorTipo('CENTRO_POBLADO').length }}</div>
            <div class="stat-label">Centros Poblados</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon total">place</mat-icon>
          <div class="stat-info">
            <div class="stat-number">{{ localidadesOtros().length }}</div>
            <div class="stat-label">Otros</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Buscador Compacto -->
  <div class="search-section">
    <div class="search-container">
      <div class="search-input">
        <mat-form-field appearance="outline">
          <mat-label>Buscar localidades...</mat-label>
          <input matInput 
                 placeholder="Nombre, ubigeo, departamento..." 
                 [(ngModel)]="terminoBusqueda"
                 (input)="buscarLocalidades($event)" />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
      </div>
      <div class="search-actions">
        <button mat-button 
                [class]="terminoBusqueda ? 'search-btn has-content' : 'search-btn'" 
                (click)="limpiarBusqueda()"
                [disabled]="!terminoBusqueda">
          <mat-icon>clear</mat-icon>
          Limpiar
        </button>
      </div>
    </div>
    
    <!-- Filtros Avanzados Toggle -->
    <div class="filtros-toggle-section">
      <button mat-button class="filtros-toggle" (click)="toggleFiltros()">
        <mat-icon>tune</mat-icon>
        Filtros Avanzados
        <mat-icon>{{ filtrosExpandidos ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- Filtros Avanzados Colapsables -->
  <div class="filtros-section" [class.collapsed]="!filtrosExpandidos">
    <div class="filtros-grid">
      <div class="filtro-group">
        <label class="filtro-label">Departamento</label>
        <div class="filtro-input">
          <mat-form-field appearance="outline">
            <mat-select placeholder="Todos" 
                       [value]="filtrosService.departamento"
                       (selectionChange)="onFiltroDepartamentoChange($event.value)">
              <mat-option value="">Todos</mat-option>
              <mat-option value="PUNO">Puno</mat-option>
              <mat-option value="OTROS" 
                         matTooltip="Localidades con datos incompletos: sin departamento, provincia o distrito estándar">
                Otros (datos incompletos)
              </mat-option>
            </mat-select>
            <mat-hint>Seleccione "Otros" para ver localidades con datos de ubicación incompletos</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <div class="filtro-group">
        <label class="filtro-label">Provincia</label>
        <div class="filtro-input">
          <mat-form-field appearance="outline">
            <mat-select placeholder="Todas"
                       [value]="filtrosService.provincia"
                       (selectionChange)="onFiltroProvinciaChange($event.value)">
              <mat-option value="">Todas</mat-option>
              @for (provincia of getProvinciasDisponibles(); track provincia) {
                <mat-option [value]="provincia">{{ provincia }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="filtro-group">
        <label class="filtro-label">Tipo</label>
        <div class="filtro-input">
          <mat-form-field appearance="outline">
            <mat-select placeholder="Todos"
                       [value]="filtrosService.tipo"
                       (selectionChange)="onFiltroTipoChange($event.value)">
              <mat-option value="">Todos</mat-option>
              <mat-option value="PROVINCIA">Provincia</mat-option>
              <mat-option value="DISTRITO">Distrito</mat-option>
              <mat-option value="CENTRO_POBLADO">Centro Poblado</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="filtro-group">
        <label class="filtro-label">Nivel Territorial</label>
        <div class="filtro-input">
          <mat-form-field appearance="outline">
            <mat-select placeholder="Todos"
                       [value]="filtrosService.nivel"
                       (selectionChange)="onFiltroNivelChange($event.value)">
              <mat-option value="">Todos</mat-option>
              <mat-option value="PROVINCIA">Provincia</mat-option>
              <mat-option value="DISTRITO">Distrito</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="filtro-group">
        <label class="filtro-label">Estado</label>
        <div class="filtro-input">
          <mat-form-field appearance="outline">
            <mat-select placeholder="Todos">
              <mat-option value="">Todos</mat-option>
              <mat-option value="true">Activo</mat-option>
              <mat-option value="false">Inactivo</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </div>

    <div class="filtros-actions">
      <button mat-button class="limpiar-filtros-btn" (click)="limpiarFiltros()">
        <mat-icon>clear_all</mat-icon>
        Limpiar Filtros
      </button>
      <button mat-raised-button class="aplicar-filtros-btn">
        <mat-icon>filter_list</mat-icon>
        Aplicar Filtros
      </button>
    </div>
  </div>

  <!-- Tabla de Localidades -->
  <mat-card class="tabla-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Lista de Localidades
      </mat-card-title>
      <mat-card-subtitle>
        Mostrando {{ resultadosFiltrados }} de {{ localidades().length }} localidades
        <span *ngIf="terminoBusqueda" class="search-indicator">
          (filtrado por: "{{ terminoBusqueda }}")
        </span>
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      @if (cargando()) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando localidades...</p>
        </div>
      } @else if (resultadosFiltrados === 0) {
        <div class="empty-state">
          <mat-icon>place_off</mat-icon>
          <h3>No hay localidades</h3>
          <p>No se encontraron localidades con los filtros aplicados</p>
          <button mat-raised-button color="primary" (click)="abrirModalNuevaLocalidad()">
            <mat-icon>add</mat-icon>
            Crear Primera Localidad
          </button>
        </div>
      } @else {
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" matSort class="localidades-table">
            
            <!-- Nombre -->
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
              <td mat-cell *matCellDef="let localidad">
                <div class="nombre-cell">
                  <div class="nombre-principal">{{ localidad.nombre || 'Sin nombre' }}</div>
                  @if (localidad.ubigeo) {
                    <div class="ubigeo-badge">{{ localidad.ubigeo }}</div>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Tipo -->
            <ng-container matColumnDef="tipo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
              <td mat-cell *matCellDef="let localidad">
                <mat-chip [class]="'tipo-' + (localidad.tipo || 'distrito').toLowerCase()">
                  {{ getTipoLabel(localidad.tipo) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Ubicación -->
            <ng-container matColumnDef="ubicacion">
              <th mat-header-cell *matHeaderCellDef>Ubicación</th>
              <td mat-cell *matCellDef="let localidad">
                <div class="ubicacion-cell">
                  @if (localidad.departamento) {
                    <div class="departamento">{{ localidad.departamento }}</div>
                  }
                  @if (localidad.provincia) {
                    <div class="provincia">{{ localidad.provincia }}</div>
                  }
                  @if (localidad.distrito) {
                    <div class="distrito">{{ localidad.distrito }}</div>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Nivel Territorial -->
            <ng-container matColumnDef="nivel">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nivel</th>
              <td mat-cell *matCellDef="let localidad">
                <mat-chip [class]="'nivel-' + (localidad.nivel_territorial || 'distrito').toLowerCase()">
                  {{ getNivelLabel(localidad.nivel_territorial) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Estado -->
            <ng-container matColumnDef="estado">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
              <td mat-cell *matCellDef="let localidad">
                <mat-chip [class]="localidad.estaActiva ? 'estado-activo' : 'estado-inactivo'">
                  <mat-icon>{{ localidad.estaActiva ? 'check_circle' : 'cancel' }}</mat-icon>
                  {{ localidad.estaActiva ? 'Activa' : 'Inactiva' }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Acciones -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let localidad">
                <div class="acciones-cell">
                  <button mat-icon-button color="primary" 
                          (click)="editarLocalidad(localidad)" 
                          matTooltip="Editar localidad">
                    <mat-icon>edit</mat-icon>
                  </button>
                  
                  <button mat-icon-button 
                          [color]="localidad.estaActiva ? 'warn' : 'accent'"
                          (click)="toggleEstado(localidad)" 
                          [matTooltip]="localidad.estaActiva ? 'Desactivar' : 'Activar'">
                    <mat-icon>{{ localidad.estaActiva ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                  
                  <button mat-icon-button color="warn" 
                          (click)="eliminarLocalidad(localidad)" 
                          matTooltip="Eliminar localidad">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
            <tr mat-row *matRowDef="let row; columns: columnasTabla;" 
                [class.fila-inactiva]="!row.estaActiva"></tr>
          </table>
          
          <!-- Paginador -->
          <mat-paginator 
            [pageSizeOptions]="config.paginacion.tamanosDisponibles" 
            [pageSize]="config.paginacion.tamanoDefault"
            showFirstLastButtons
            aria-label="Seleccionar página de localidades">
          </mat-paginator>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

<!-- Modal de Localidad - FUERA del contenedor principal -->
@if (mostrarModal()) {
  <app-localidad-modal
    [localidad]="localidadSeleccionada()"
    [esEdicion]="esEdicion()"
    (guardar)="guardarLocalidad($event)"
    (cancelar)="cerrarModal()">
  </app-localidad-modal>
}