<!-- Modal para crear/editar localidades -->
<div class="modal-overlay" (click)="onCancelar()">
  <div class="modal-container">>>
    <div class="modal-header">
      <h2>
        <mat-icon>{{ esEdicion ? 'edit' : 'add' }}</mat-icon>
        {{ esEdicion ? 'Editar Localidad' : 'Nueva Localidad' }}
      </h2>
      <button mat-icon-button (click)="onCancelar()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form [formGroup]="formulario" (ngSubmit)="onGuardar()" (click)="$event.stopPropagation()" class="modal-form">
      <div class="modal-content">
        
        <!-- Informaci贸n B谩sica -->
        <div class="seccion-basica">
          <h3>Informaci贸n B谩sica</h3>
          
          <div class="campos-grid">
            <!-- Nombre (OBLIGATORIO) -->
            <mat-form-field appearance="outline" class="campo-completo">
              <mat-label>Nombre de la Localidad *</mat-label>
              <input matInput formControlName="nombre" placeholder="Ej: Puno, Juliaca, Az谩ngaro">
              <mat-icon matSuffix>place</mat-icon>
              @if (formulario.get('nombre')?.hasError('required')) {
                <mat-error>El nombre es obligatorio</mat-error>
              }
              @if (formulario.get('nombre')?.hasError('minlength')) {
                <mat-error>El nombre debe tener al menos 2 caracteres</mat-error>
              }
            </mat-form-field>

            <!-- Tipo (por defecto PUEBLO) -->
            <div class="tipo-selector">
              <label class="tipo-label">Tipo de Localidad *</label>
              <div class="tipo-opciones">
                @for (tipo of tiposLocalidad; track tipo.value) {
                  <div class="tipo-opcion" 
                       [class.selected]="tipoSeleccionado === tipo.value"
                       (click)="seleccionarTipo(tipo.value)">
                    <div class="tipo-radio">
                      <input type="radio" 
                             [id]="'tipo-' + tipo.value" 
                             [value]="tipo.value"
                             [checked]="tipoSeleccionado === tipo.value"
                             (change)="seleccionarTipo(tipo.value)">
                      <span class="radio-custom"></span>
                    </div>
                    <label [for]="'tipo-' + tipo.value" class="tipo-texto">
                      {{ tipo.label }}
                    </label>
                  </div>
                }
              </div>
              <div class="tipo-hint">{{ getHintPorTipo() }}</div>
            </div>
          </div>
        </div>

        <!-- Ubicaci贸n Administrativa (Condicional seg煤n tipo) -->
        @if (mostrarCamposJerarquicos()) {
          <div class="seccion-ubicacion">
            <h3>{{ getTituloSeccionUbicacion() }}</h3>
            
            <div class="campos-grid">
              <!-- Departamento (solo para PROVINCIA y niveles inferiores) -->
              @if (mostrarCampoDepartamento()) {
                @if (usarSelectDepartamento()) {
                  <!-- Select din谩mico cuando hay m煤ltiples opciones -->
                  <mat-form-field appearance="outline">
                    <mat-label>Departamento</mat-label>
                    <mat-select formControlName="departamento" panelClass="select-panel-high-z-index">
                      <mat-option value="">Seleccionar departamento</mat-option>
                      @for (dept of departamentosDisponibles; track dept) {
                        <mat-option [value]="dept">{{ dept }}</mat-option>
                      }
                    </mat-select>
                    <mat-icon matSuffix>map</mat-icon>
                  </mat-form-field>
                } @else {
                  <!-- Input cuando solo hay una opci贸n o est谩 cargando -->
                  <mat-form-field appearance="outline">
                    <mat-label>Departamento</mat-label>
                    <input matInput formControlName="departamento" placeholder="Por defecto: PUNO">
                    <mat-icon matSuffix>map</mat-icon>
                    @if (cargandoOpciones) {
                      <mat-spinner matSuffix diameter="20"></mat-spinner>
                    }
                  </mat-form-field>
                }
              }

              <!-- Provincia (solo para DISTRITO y niveles inferiores) -->
              @if (mostrarCampoProvincia()) {
                @if (usarSelectProvincia()) {
                  <!-- Autocomplete con b煤squeda cuando hay m煤ltiples opciones -->
                  <mat-form-field appearance="outline">
                    <mat-label>Provincia</mat-label>
                    <input matInput 
                           [formControl]="provinciaControl"
                           [matAutocomplete]="provinciaAuto"
                           placeholder="Buscar provincia..."
                           [disabled]="provinciasDisponibles.length === 0">
                    <mat-autocomplete #provinciaAuto="matAutocomplete" 
                                    panelClass="select-panel-high-z-index"
                                    (optionSelected)="onProvinciaSelected($event)">
                      @for (provincia of provinciasFiltradas | async; track provincia) {
                        <mat-option [value]="provincia">
                          {{ provincia }}
                        </mat-option>
                      }
                      @if ((provinciasFiltradas | async)?.length === 0) {
                        <mat-option disabled>
                          No se encontraron provincias
                        </mat-option>
                      }
                    </mat-autocomplete>
                    <mat-icon matSuffix>location_city</mat-icon>
                    @if (cargandoOpciones) {
                      <mat-spinner matSuffix diameter="20"></mat-spinner>
                    }
                  </mat-form-field>
                } @else {
                  <!-- Input cuando solo hay una opci贸n o no hay departamento seleccionado -->
                  <mat-form-field appearance="outline">
                    <mat-label>Provincia</mat-label>
                    <input matInput formControlName="provincia" 
                           placeholder="Por defecto: PUNO"
                           [disabled]="provinciasDisponibles.length === 0">
                    <mat-icon matSuffix>location_city</mat-icon>
                    @if (cargandoOpciones) {
                      <mat-spinner matSuffix diameter="20"></mat-spinner>
                    }
                  </mat-form-field>
                }
              }

              <!-- Distrito (solo para PUEBLO y CENTRO_POBLADO) -->
              @if (mostrarCampoDistrito()) {
                @if (usarSelectDistrito()) {
                  <!-- Autocomplete con b煤squeda cuando hay m煤ltiples opciones -->
                  <mat-form-field appearance="outline">
                    <mat-label>Distrito</mat-label>
                    <input matInput 
                           [formControl]="distritoControl"
                           [matAutocomplete]="distritoAuto"
                           placeholder="Buscar distrito..."
                           [disabled]="distritosDisponibles.length === 0">
                    <mat-autocomplete #distritoAuto="matAutocomplete" 
                                    panelClass="select-panel-high-z-index"
                                    (optionSelected)="onDistritoSelected($event)">
                      @for (distrito of distritosFiltrados | async; track distrito) {
                        <mat-option [value]="distrito">
                          {{ distrito }}
                        </mat-option>
                      }
                      @if ((distritosFiltrados | async)?.length === 0) {
                        <mat-option disabled>
                          No se encontraron distritos
                        </mat-option>
                      }
                    </mat-autocomplete>
                    <mat-icon matSuffix>place</mat-icon>
                    @if (cargandoOpciones) {
                      <mat-spinner matSuffix diameter="20"></mat-spinner>
                    }
                  </mat-form-field>
                } @else {
                  <!-- Input cuando solo hay una opci贸n o no hay provincia seleccionada -->
                  <mat-form-field appearance="outline">
                    <mat-label>Distrito</mat-label>
                    <input matInput formControlName="distrito" 
                           placeholder="Por defecto: PUNO"
                           [disabled]="distritosDisponibles.length === 0">
                    <mat-icon matSuffix>place</mat-icon>
                    @if (cargandoOpciones) {
                      <mat-spinner matSuffix diameter="20"></mat-spinner>
                    }
                  </mat-form-field>
                }
              }

              <!-- UBIGEO (solo para CENTRO_POBLADO) -->
              @if (mostrarCampoUbigeo()) {
                <mat-form-field appearance="outline">
                  <mat-label>UBIGEO</mat-label>
                  <input matInput formControlName="ubigeo" placeholder="Ej: 210101" maxlength="6">
                  <mat-icon matSuffix>pin</mat-icon>
                  @if (formulario.get('ubigeo')?.hasError('pattern')) {
                    <mat-error>El UBIGEO debe tener 6 d铆gitos</mat-error>
                  }
                </mat-form-field>
              }
            </div>
          </div>
        }

        <!-- Informaci贸n Adicional (Opcional) -->
        <mat-expansion-panel class="seccion-adicional">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>info</mat-icon>
              Informaci贸n Adicional (Opcional)
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="campos-grid">
            <mat-form-field appearance="outline" class="campo-completo">
              <mat-label>Descripci贸n</mat-label>
              <textarea matInput formControlName="descripcion" rows="3" 
                        placeholder="Descripci贸n de la localidad"></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="campo-completo">
              <mat-label>Observaciones</mat-label>
              <textarea matInput formControlName="observaciones" rows="2" 
                        placeholder="Observaciones adicionales"></textarea>
            </mat-form-field>
          </div>
        </mat-expansion-panel>

        <!-- Coordenadas (Opcional) -->
        <mat-expansion-panel class="seccion-coordenadas">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>my_location</mat-icon>
              Coordenadas Geogr谩ficas (Opcional)
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="campos-grid">
            <mat-form-field appearance="outline">
              <mat-label>Latitud</mat-label>
              <input matInput type="number" formControlName="latitud" 
                     placeholder="Ej: -15.8422" step="0.000001">
              <mat-icon matSuffix>south</mat-icon>
              @if (formulario.get('latitud')?.hasError('min') || formulario.get('latitud')?.hasError('max')) {
                <mat-error>La latitud debe estar entre -90 y 90</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Longitud</mat-label>
              <input matInput type="number" formControlName="longitud" 
                     placeholder="Ej: -70.0199" step="0.000001">
              <mat-icon matSuffix>east</mat-icon>
              @if (formulario.get('longitud')?.hasError('min') || formulario.get('longitud')?.hasError('max')) {
                <mat-error>La longitud debe estar entre -180 y 180</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-expansion-panel>

        <!-- Informaci贸n del Sistema -->
        @if (esEdicion && localidad) {
          <div class="seccion-sistema">
            <h3>Informaci贸n del Sistema</h3>
            <div class="info-sistema">
              <div class="info-item">
                <mat-icon>schedule</mat-icon>
                <div>
                  <div class="info-label">Fecha de Creaci贸n</div>
                  <div class="info-value">{{ localidad.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</div>
                </div>
              </div>
              <div class="info-item">
                <mat-icon>update</mat-icon>
                <div>
                  <div class="info-label">ltima Actualizaci贸n</div>
                  <div class="info-value">{{ localidad.fechaActualizacion | date:'dd/MM/yyyy HH:mm' }}</div>
                </div>
              </div>
              <div class="info-item">
                <mat-icon>{{ localidad.estaActiva ? 'check_circle' : 'cancel' }}</mat-icon>
                <div>
                  <div class="info-label">Estado</div>
                  <div class="info-value">{{ localidad.estaActiva ? 'Activa' : 'Inactiva' }}</div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="modal-actions">
        <!-- Bot贸n temporal de debugging -->
        <button type="button" mat-stroked-button (click)="debugFormulario()" style="background-color: #ff9800; color: white;">
           Debug
        </button>
        
        <button type="button" mat-stroked-button (click)="onCancelar()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        
        <button type="submit" mat-raised-button color="primary" 
                [disabled]="formulario.invalid || guardando">
          @if (guardando) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            <mat-icon>{{ esEdicion ? 'save' : 'add' }}</mat-icon>
          }
          {{ esEdicion ? 'Actualizar' : 'Crear' }} Localidad
        </button>
      </div>
    </form>
  </div>
</div>