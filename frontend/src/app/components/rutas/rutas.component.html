<div class="rutas-container">
  <div class="page-header">
    <div>
      <h1>Gestión de Rutas</h1>
      <p>Administra las rutas de transporte del sistema</p>
    </div>
    <div class="header-actions">
      <!-- Acciones de selección múltiple -->
      @if (rutasSeleccionadas().size > 0) {
        <div class="selection-actions">
          <span class="selection-count">{{ rutasSeleccionadas().size }} seleccionadas</span>
          <button mat-stroked-button 
                  color="warn" 
                  (click)="eliminarSeleccionadas()"
                  matTooltip="Eliminar rutas seleccionadas">
            <mat-icon>delete</mat-icon>
            Eliminar ({{ rutasSeleccionadas().size }})
          </button>
          <button mat-stroked-button 
                  color="primary" 
                  (click)="exportarSeleccionadas()"
                  matTooltip="Exportar rutas seleccionadas">
            <mat-icon>download</mat-icon>
            Exportar ({{ rutasSeleccionadas().size }})
          </button>
          <button mat-button 
                  (click)="limpiarSeleccion()"
                  matTooltip="Limpiar selección">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
        </div>
      }
      
      <!-- Configuración de columnas -->
      <button mat-icon-button 
              [matMenuTriggerFor]="columnasMenu"
              matTooltip="Configurar columnas">
        <mat-icon>view_column</mat-icon>
      </button>
      
      <mat-menu #columnasMenu="matMenu" class="columnas-menu">
        <div class="menu-header" (click)="$event.stopPropagation()">
          <h4>Configurar Columnas</h4>
        </div>
        @for (columna of columnasDisponibles; track columna.key) {
          @if (!columna.fixed) {
            <mat-checkbox 
              class="columna-checkbox"
              [checked]="columna.visible"
              (change)="toggleColumna(columna.key, $event.checked)"
              (click)="$event.stopPropagation()">
              {{ columna.label }}
            </mat-checkbox>
          }
        }
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="resetearColumnas()">
          <mat-icon>refresh</mat-icon>
          Resetear por defecto
        </button>
      </mat-menu>
      
      <!-- Exportación general -->
      <button mat-icon-button 
              [matMenuTriggerFor]="exportMenu"
              matTooltip="Exportar datos">
        <mat-icon>download</mat-icon>
      </button>
      
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportarTodas('excel')">
          <mat-icon>table_chart</mat-icon>
          Exportar a Excel
        </button>
        <button mat-menu-item (click)="exportarTodas('csv')">
          <mat-icon>description</mat-icon>
          Exportar a CSV
        </button>
        <button mat-menu-item (click)="exportarTodas('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          Exportar a PDF
        </button>
      </mat-menu>
      
      <button mat-raised-button 
              color="primary" 
              (click)="nuevaRuta()">
        <mat-icon>add</mat-icon>
        Nueva Ruta
      </button>
      <button mat-stroked-button 
              color="accent" 
              routerLink="/rutas/estadisticas"
              matTooltip="Ver estadísticas de rutas">
        <mat-icon>analytics</mat-icon>
        Estadísticas
      </button>
      <button mat-stroked-button 
              color="accent" 
              routerLink="/rutas/carga-masiva"
              matTooltip="Importar múltiples rutas desde Excel">
        <mat-icon>upload</mat-icon>
        Carga Masiva
      </button>
      <button mat-stroked-button 
              color="accent" 
              (click)="recargarRutas()"
              [disabled]="isLoading()">
        <mat-icon>refresh</mat-icon>
        Recargar
      </button>
    </div>
  </div>

  <!-- Buscador Simple -->
  <mat-card class="search-card">
    <mat-card-content>
      <div class="search-container">
        <!-- Buscador Principal -->
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar rutas...</mat-label>
          <input matInput 
                 [ngModel]="terminoBusqueda()"
                 (ngModelChange)="terminoBusqueda.set($event)"
                 (input)="onBusquedaChange($event)"
                 placeholder="Código, empresa, origen-destino, etc."
                 (keydown.enter)="buscarRutas()">
          <button matSuffix 
                  mat-icon-button 
                  (click)="buscarRutas()"
                  [disabled]="!terminoBusqueda()"
                  matTooltip="Buscar">
            <mat-icon>search</mat-icon>
          </button>
        </mat-form-field>

        <!-- Botón Filtros Avanzados -->
        <button mat-stroked-button 
                (click)="abrirFiltrosAvanzados()"
                class="filtros-btn"
                [class.active]="tieneFiltrosAvanzados()">
          <mat-icon>tune</mat-icon>
          Filtros Avanzados
          @if (tieneFiltrosAvanzados()) {
            <span class="filtros-badge">{{ getFiltrosActivosChips().length }}</span>
          }
        </button>

        <!-- Limpiar búsqueda y filtros -->
        @if (terminoBusqueda() || tieneFiltrosAvanzados()) {
          <button mat-icon-button 
                  (click)="limpiarTodo()"
                  matTooltip="Limpiar búsqueda y filtros">
            <mat-icon>clear</mat-icon>
          </button>
        }
      </div>

      <!-- Chips de filtros activos -->
      @if (terminoBusqueda() || tieneFiltrosAvanzados()) {
        <div class="filtros-activos">
          <span class="filtros-label">Filtros activos:</span>
          <mat-chip-set>
            @if (terminoBusqueda()) {
              <mat-chip (removed)="limpiarBusqueda()">
                Búsqueda: "{{ terminoBusqueda() }}"
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            }
            @for (filtro of getFiltrosActivosChips(); track filtro.key) {
              <mat-chip (removed)="removerFiltro(filtro.key)">
                {{ filtro.label }}: {{ filtro.value }}
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Información de resultados -->
  @if (filtroActivo().tipo !== 'todas') {
    <mat-card class="info-card">
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Vista actual:</span>
            <span class="value">{{ filtroActivo().descripcion }}</span>
          </div>
          <div class="info-item">
            <span class="label">Rutas encontradas:</span>
            <span class="value">{{ (rutasFiltradas())?.length || 0 }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>Cargando rutas...</p>
    </div>
  }

  <!-- Tabla de Rutas -->
  @if (!isLoading() && rutasPaginadas().length > 0) {
    <div class="content-section">
      <div class="section-header">
        <h3>{{ filtroActivo().descripcion }}</h3>
        <p class="section-subtitle">
          Mostrando {{ (rutasPaginadas())?.length || 0 }} de {{ (rutasFiltradas())?.length || 0 }} ruta(s)
        </p>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="rutasPaginadas()" class="rutas-table">
          
          <!-- Columna de selección -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox 
                [checked]="todasSeleccionadas()"
                [indeterminate]="rutasSeleccionadas().size > 0 && !todasSeleccionadas()"
                (change)="toggleTodasSeleccionadas($event.checked)">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let ruta">
              <mat-checkbox 
                [checked]="rutasSeleccionadas().has(ruta.id)"
                (change)="toggleRutaSeleccionada(ruta.id, $event.checked)">
              </mat-checkbox>
            </td>
          </ng-container>
          
          <!-- Empresa -->
          <ng-container matColumnDef="empresa">
            <th mat-header-cell *matHeaderCellDef>Empresa</th>
            <td mat-cell *matCellDef="let ruta">
              <div class="empresa-info">
                <span class="empresa-nombre">{{ getEmpresaNombre(ruta) }}</span>
                <span class="empresa-ruc">{{ ruta.empresa?.ruc || 'Sin RUC' }}</span>
              </div>
            </td>
          </ng-container>
          
          <!-- RUC -->
          <ng-container matColumnDef="ruc">
            <th mat-header-cell *matHeaderCellDef>RUC</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="ruc-text">{{ ruta.empresa?.ruc || 'Sin RUC' }}</span>
            </td>
          </ng-container>

          <!-- Resolución -->
          <ng-container matColumnDef="resolucion">
            <th mat-header-cell *matHeaderCellDef>Resolución</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="resolucion-text">{{ ruta.resolucion?.nroResolucion || 'Sin resolución' }}</span>
            </td>
          </ng-container>

          <!-- Código de Ruta -->
          <ng-container matColumnDef="codigoRuta">
            <th mat-header-cell *matHeaderCellDef>Código Ruta</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="codigo-ruta">{{ ruta.codigoRuta }}</span>
            </td>
          </ng-container>

          <!-- Origen -->
          <ng-container matColumnDef="origen">
            <th mat-header-cell *matHeaderCellDef>Origen</th>
            <td mat-cell *matCellDef="let ruta">{{ ruta.origen?.nombre || 'Sin origen' }}</td>
          </ng-container>

          <!-- Destino -->
          <ng-container matColumnDef="destino">
            <th mat-header-cell *matHeaderCellDef>Destino</th>
            <td mat-cell *matCellDef="let ruta">{{ ruta.destino?.nombre || 'Sin destino' }}</td>
          </ng-container>

          <!-- Itinerario -->
          <ng-container matColumnDef="itinerario">
            <th mat-header-cell *matHeaderCellDef>Itinerario</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="itinerario-text">
                {{ ruta.descripcion || ruta.nombre || getNombreRuta(ruta) }}
              </span>
            </td>
          </ng-container>

          <!-- Frecuencias -->
          <ng-container matColumnDef="frecuencias">
            <th mat-header-cell *matHeaderCellDef>Frecuencias</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="frecuencias-text">{{ ruta.frecuencias || 'Sin frecuencias' }}</span>
            </td>
          </ng-container>

          <!-- Tipo Ruta -->
          <ng-container matColumnDef="tipoRuta">
            <th mat-header-cell *matHeaderCellDef>Tipo Ruta</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="tipo-ruta-text">{{ ruta.tipoRuta || 'Sin tipo' }}</span>
            </td>
          </ng-container>

          <!-- Tipo Servicio -->
          <ng-container matColumnDef="tipoServicio">
            <th mat-header-cell *matHeaderCellDef>Tipo Servicio</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="tipo-servicio-text">{{ ruta.tipoServicio || 'Sin tipo servicio' }}</span>
            </td>
          </ng-container>

          <!-- Estado -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let ruta">
              <span class="estado-badge" [class.activo]="ruta.estado === 'ACTIVA'">
                {{ ruta.estado }}
              </span>
            </td>
          </ng-container>

          <!-- Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let ruta">
              <button mat-icon-button 
                      color="accent" 
                      (click)="verDetalleRuta(ruta)"
                      matTooltip="Ver detalles">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button 
                      color="primary" 
                      (click)="editarRuta(ruta)"
                      matTooltip="Editar ruta">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button 
                      color="warn" 
                      (click)="eliminarRuta(ruta)"
                      matTooltip="Eliminar ruta">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns();" 
              [class.selected-row]="rutasSeleccionadas().has(row.id)"></tr>
        </table>
      </div>

      <!-- Paginador -->
      <mat-paginator 
        [length]="rutasFiltradas().length"
        [pageSize]="pageSize()"
        [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  }

  <!-- Sin resultados -->
  @if (!isLoading() && rutasFiltradas().length === 0) {
    <div class="no-results">
      <mat-icon>route</mat-icon>
      <h3>No se encontraron rutas</h3>
      <p>No hay rutas que coincidan con la búsqueda.</p>
      <button mat-raised-button color="primary" (click)="limpiarTodo()">
        Limpiar Filtros
      </button>
    </div>
  }
</div>