<div class="form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ isEditing() ? 'edit' : 'add' }}</mat-icon>
        {{ isEditing() ? 'Editar' : 'Nuevo' }} Vehículo
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (isLoading()) {
        <div class="loading">
          <mat-spinner></mat-spinner>
          <p>Cargando...</p>
        </div>
      } @else {
        <form [formGroup]="vehiculoForm">
          
          <!-- Sección: Identificación -->
          <h3 class="section-title">
            <mat-icon>badge</mat-icon>
            Identificación del Vehículo
          </h3>
          
          <div class="form-grid">
            <!-- Placa con búsqueda en VehiculoSolo -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Placa *</mat-label>
              <input matInput 
                     formControlName="placa" 
                     placeholder="Ej: ABC-123"
                     (blur)="buscarVehiculoSoloPorPlaca()"
                     maxlength="9">
              <mat-icon matPrefix>directions_car</mat-icon>
              @if (vehiculoSoloEncontrado()) {
                <mat-icon matSuffix class="icono-exito" matTooltip="Vehículo encontrado en datos técnicos">check_circle</mat-icon>
              }
              @if (vehiculoForm.get('placa')?.hasError('required')) {
                <mat-error>La placa es requerida</mat-error>
              }
              @if (vehiculoForm.get('placa')?.hasError('placaInvalida')) {
                <mat-error>Formato de placa inválido</mat-error>
              }
            </mat-form-field>

            <!-- Mostrar datos técnicos si se encontró el vehículo -->
            @if (vehiculoSoloEncontrado() && vehiculoSoloData()) {
              <div class="vehiculo-solo-info full-width">
                <mat-icon>info</mat-icon>
                <div class="info-content">
                  <strong>Datos Técnicos:</strong>
                  {{ vehiculoSoloData()?.marca }} {{ vehiculoSoloData()?.modelo }} 
                  ({{ vehiculoSoloData()?.anio_fabricacion }})
                  - {{ vehiculoSoloData()?.categoria }}
                </div>
                <button mat-icon-button 
                        type="button"
                        matTooltip="Ver detalles completos"
                        (click)="verDetallesVehiculoSolo()">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            }

            @if (!vehiculoSoloEncontrado() && placaBuscada()) {
              <div class="vehiculo-solo-warning full-width">
                <mat-icon>warning</mat-icon>
                <div class="warning-content">
                  <strong>Vehículo no encontrado en datos técnicos</strong>
                  <p>Debes registrar primero los datos técnicos del vehículo</p>
                </div>
                <button mat-raised-button 
                        color="primary"
                        type="button"
                        (click)="crearVehiculoSolo()">
                  <mat-icon>add</mat-icon>
                  Crear Datos Técnicos
                </button>
              </div>
            }
          </div>

          <mat-divider></mat-divider>

          <!-- Sección: Asignación Administrativa -->
          <h3 class="section-title">
            <mat-icon>business</mat-icon>
            Asignación Administrativa
          </h3>

          <div class="form-grid">
            <!-- Empresa -->
            <mat-form-field appearance="outline">
              <mat-label>Empresa *</mat-label>
              <mat-select formControlName="empresaActualId" (selectionChange)="onEmpresaChange()">
                <mat-option value="">-- Seleccionar --</mat-option>
                @for (empresa of empresas(); track empresa.id) {
                  <mat-option [value]="empresa.id">
                    {{ empresa.razonSocial?.principal || empresa.ruc }}
                  </mat-option>
                }
              </mat-select>
              @if (vehiculoForm.get('empresaActualId')?.hasError('required')) {
                <mat-error>La empresa es requerida</mat-error>
              }
            </mat-form-field>

            <!-- Tipo de Servicio -->
            <mat-form-field appearance="outline">
              <mat-label>Tipo de Servicio *</mat-label>
              <mat-select formControlName="tipoServicio">
                <mat-option value="">-- Seleccionar --</mat-option>
                @for (tipo of tiposServicioDisponibles(); track tipo) {
                  <mat-option [value]="tipo">{{ tipo }}</mat-option>
                }
              </mat-select>
              <mat-hint>Debe coincidir con los servicios de la empresa</mat-hint>
              @if (vehiculoForm.get('tipoServicio')?.hasError('required')) {
                <mat-error>El tipo de servicio es requerido</mat-error>
              }
            </mat-form-field>

            <!-- Resolución -->
            <mat-form-field appearance="outline">
              <mat-label>Resolución</mat-label>
              <mat-select formControlName="resolucionId">
                <mat-option value="">-- Sin resolución --</mat-option>
                @for (resolucion of resoluciones(); track resolucion.id) {
                  <mat-option [value]="resolucion.id">
                    {{ resolucion.nroResolucion }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <!-- Estado -->
            <mat-form-field appearance="outline">
              <mat-label>Estado *</mat-label>
              <mat-select formControlName="estado">
                <mat-option value="ACTIVO">Activo</mat-option>
                <mat-option value="INACTIVO">Inactivo</mat-option>
                <mat-option value="MANTENIMIENTO">En Mantenimiento</mat-option>
                <mat-option value="SUSPENDIDO">Suspendido</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <!-- Sección: Rutas -->
          <h3 class="section-title">
            <mat-icon>route</mat-icon>
            Rutas Asignadas
          </h3>

          <div class="form-grid">
            <!-- Rutas Generales -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Rutas Generales</mat-label>
              <mat-select formControlName="rutasAsignadasIds" multiple>
                @for (ruta of rutasDisponibles(); track ruta.id) {
                  <mat-option [value]="ruta.id">
                    {{ ruta.origen }} - {{ ruta.destino }}
                  </mat-option>
                }
              </mat-select>
              <mat-hint>Rutas de la resolución o empresa</mat-hint>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <!-- Sección: Observaciones -->
          <h3 class="section-title">
            <mat-icon>notes</mat-icon>
            Observaciones
          </h3>

          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Observaciones</mat-label>
              <textarea matInput 
                        formControlName="observaciones" 
                        rows="3"
                        placeholder="Notas administrativas sobre el vehículo"></textarea>
            </mat-form-field>
          </div>

          <!-- Acciones -->
          <div class="actions">
            <button mat-button 
                    type="button" 
                    (click)="cancelar()"
                    [disabled]="isSubmitting()">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
            <button mat-raised-button 
                    color="primary" 
                    type="button"
                    (click)="guardar()"
                    [disabled]="!vehiculoForm.valid || isSubmitting() || !vehiculoSoloEncontrado()">
              <mat-icon>save</mat-icon>
              {{ isEditing() ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>
