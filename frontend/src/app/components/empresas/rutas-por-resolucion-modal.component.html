<div class="modal-header">
  <div class="header-content">
    <div class="header-icon">
      <app-smart-icon [iconName]="'route'" [size]="32"></app-smart-icon>
    </div>
    <div class="header-text">
      <h2 mat-dialog-title>Rutas por Resolución</h2>
      <p class="header-subtitle">
        <strong>{{ data.empresa.ruc }}</strong> - {{ data.empresa.razonSocial.principal }}
      </p>
    </div>
  </div>
  <button mat-icon-button mat-dialog-close class="close-button">
    <app-smart-icon [iconName]="'close'" [size]="24"></app-smart-icon>
  </button>
</div>

<mat-dialog-content class="modal-content">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando rutas...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && resolucionesConRutas().length === 0) {
    <div class="empty-state">
      <app-smart-icon [iconName]="'route_off'" [size]="64"></app-smart-icon>
      <h3>No hay rutas registradas</h3>
      <p>Esta empresa no tiene rutas asignadas a ninguna resolución.</p>
    </div>
  }

  <!-- Rutas por Resolución -->
  @if (!isLoading() && resolucionesConRutas().length > 0) {
    <div class="resolucion-summary">
      <div class="summary-stats">
        <div class="stat-item">
          <span class="stat-value">{{ resolucionesConRutas().length }}</span>
          <span class="stat-label">Resoluciones</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ totalRutas() }}</span>
          <span class="stat-label">Rutas Totales</span>
        </div>
      </div>
    </div>

    <mat-accordion class="resoluciones-accordion">
      @for (resolucionData of resolucionesConRutas(); track resolucionData.resolucion.id) {
        <mat-expansion-panel class="resolucion-panel" [expanded]="$index === 0">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="resolucion-header">
                <div class="resolucion-info">
                  <span class="resolucion-numero">{{ resolucionData.resolucion.nroResolucion }}</span>
                  <mat-chip-set>
                    <mat-chip [color]="getEstadoColor(resolucionData.resolucion.estado || 'VIGENTE')" selected>
                      {{ resolucionData.resolucion.estado || 'VIGENTE' }}
                    </mat-chip>
                  </mat-chip-set>
                </div>
                <div class="resolucion-stats">
                  <mat-chip color="primary" selected>
                    {{ resolucionData.totalRutas }} rutas
                  </mat-chip>
                </div>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              <div class="resolucion-description">
                <span>{{ formatFecha(resolucionData.resolucion.fechaEmision) }}</span>
                <span class="separator">•</span>
                <span>{{ resolucionData.resolucion.tipoTramite }}</span>
              </div>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <!-- Tabla de Rutas -->
          <div class="rutas-table-container">
            <table mat-table [dataSource]="resolucionData.rutas" class="rutas-table">
              <!-- Código Column -->
              <ng-container matColumnDef="codigo">
                <th mat-header-cell *matHeaderCellDef>Código</th>
                <td mat-cell *matCellDef="let ruta">
                  <span class="ruta-codigo">{{ ruta.codigo }}</span>
                </td>
              </ng-container>

              <!-- Nombre Column -->
              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>Nombre de Ruta</th>
                <td mat-cell *matCellDef="let ruta">
                  <div class="ruta-nombre">
                    <span class="nombre-principal">{{ ruta.nombre }}</span>
                    @if (ruta.descripcion) {
                      <span class="descripcion">{{ ruta.descripcion }}</span>
                    }
                  </div>
                </td>
              </ng-container>

              <!-- Origen-Destino Column -->
              <ng-container matColumnDef="origen-destino">
                <th mat-header-cell *matHeaderCellDef>Origen - Destino</th>
                <td mat-cell *matCellDef="let ruta">
                  <div class="origen-destino">
                    <div class="localidad">
                      <app-smart-icon [iconName]="'place'" [size]="16"></app-smart-icon>
                      <span>{{ ruta.origen.nombre }}</span>
                    </div>
                    <app-smart-icon [iconName]="'arrow_forward'" [size]="16" class="arrow"></app-smart-icon>
                    <div class="localidad">
                      <app-smart-icon [iconName]="'flag'" [size]="16"></app-smart-icon>
                      <span>{{ ruta.destino.nombre }}</span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Distancia Column -->
              <ng-container matColumnDef="distancia">
                <th mat-header-cell *matHeaderCellDef>Distancia</th>
                <td mat-cell *matCellDef="let ruta">
                  <span class="distancia">{{ ruta.distanciaKm }} km</span>
                </td>
              </ng-container>

              <!-- Tarifa Column -->
              <ng-container matColumnDef="tarifa">
                <th mat-header-cell *matHeaderCellDef>Tarifa Base</th>
                <td mat-cell *matCellDef="let ruta">
                  <span class="tarifa">S/ {{ ruta.tarifaBase?.toFixed(2) || '0.00' }}</span>
                </td>
              </ng-container>

              <!-- Estado Column -->
              <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef>Estado</th>
                <td mat-cell *matCellDef="let ruta">
                  <mat-chip [color]="getEstadoRutaColor(ruta.estado)" selected>
                    {{ ruta.estado }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Acciones Column -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let ruta">
                  <div class="acciones">
                    <button mat-icon-button 
                            (click)="verDetalleRuta(ruta)"
                            matTooltip="Ver detalles de la ruta">
                      <app-smart-icon [iconName]="'visibility'" [size]="20"></app-smart-icon>
                    </button>
                    <button mat-icon-button 
                            (click)="editarRuta(ruta)"
                            matTooltip="Editar ruta">
                      <app-smart-icon [iconName]="'edit'" [size]="20"></app-smart-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            @if (resolucionData.rutas.length === 0) {
              <div class="no-rutas">
                <p>No hay rutas registradas para esta resolución.</p>
              </div>
            }
          </div>
        </mat-expansion-panel>
      }
    </mat-accordion>
  }
</mat-dialog-content>

<mat-dialog-actions class="modal-actions">
  <button mat-button mat-dialog-close>
    <app-smart-icon [iconName]="'close'" [size]="20"></app-smart-icon>
    Cerrar
  </button>
  <button mat-raised-button color="primary" (click)="exportarRutas()">
    <app-smart-icon [iconName]="'download'" [size]="20"></app-smart-icon>
    Exportar
  </button>
</mat-dialog-actions>