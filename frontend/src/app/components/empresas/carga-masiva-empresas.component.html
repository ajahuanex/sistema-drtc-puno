<div class="carga-masiva-container">
  <!-- Header Compacto -->
  <div class="header-compact">
    <div class="header-content">
      <i class="fas fa-building"></i>
      <div>
        <h2>Carga Masiva de Empresas</h2>
        <p>Importa múltiples empresas desde Excel</p>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div *ngIf="mostrarMensajeFlag" class="alert-modern" [ngClass]="'alert-' + tipoMensaje">
    <i [ngClass]="{
      'fas fa-check-circle': tipoMensaje === 'success',
      'fas fa-exclamation-triangle': tipoMensaje === 'warning',
      'fas fa-times-circle': tipoMensaje === 'error',
      'fas fa-info-circle': tipoMensaje === 'info'
    }"></i>
    <span [innerHTML]="mensaje"></span>
    <button (click)="ocultarMensaje()"><i class="fas fa-times"></i></button>
  </div>

  <!-- Sección Principal -->
  <div class="main-section">
    
    <!-- Plantilla y Upload en una sola card -->
    <div class="upload-card">
      <div class="card-header">
        <h3><i class="fas fa-cloud-upload-alt"></i> Cargar Archivo</h3>
        <button class="btn-download" (click)="descargarPlantilla()" [disabled]="cargando">
          <i *ngIf="!cargando" class="fas fa-download"></i>
          <span *ngIf="cargando" class="spinner"></span>
          Plantilla
        </button>
      </div>
      
      <div class="card-content">
        <!-- Upload Area Compacta -->
        <div class="upload-zone" 
             [class.has-file]="archivoSeleccionado" 
             [class.dragover]="isDragOver"
             (click)="fileInput.click()"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)">
          <input #fileInput 
                 type="file" 
                 accept=".xlsx,.xls" 
                 (change)="onArchivoSeleccionado($event)" 
                 hidden>
          
          <div *ngIf="!archivoSeleccionado" class="upload-empty">
            <i class="fas fa-cloud-upload-alt"></i>
            <div>
              <strong>Arrastra o selecciona tu archivo Excel</strong>
              <small>Formatos: .xlsx, .xls (máx. 10MB)</small>
            </div>
          </div>

          <div *ngIf="archivoSeleccionado" class="upload-filled">
            <i class="fas fa-file-excel"></i>
            <div class="file-info">
              <strong>{{ archivoSeleccionado.name }}</strong>
              <small>{{ (archivoSeleccionado.size / 1024).toFixed(2) }} KB</small>
            </div>
            <button class="btn-remove" (click)="reiniciar(); $event.stopPropagation()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Opciones Compactas -->
        <div class="options-row">
          <div class="radio-group">
            <label class="radio-option" [class.active]="soloValidar" (click)="soloValidar = true">
              <input type="radio" name="modoOperacion" [value]="true" [checked]="soloValidar">
              <i class="fas fa-search"></i>
              <span>Solo Validar</span>
            </label>
            <label class="radio-option" [class.active]="!soloValidar" (click)="soloValidar = false">
              <input type="radio" name="modoOperacion" [value]="false" [checked]="!soloValidar">
              <i class="fas fa-rocket"></i>
              <span>Validar y Crear</span>
            </label>
          </div>
          
          <div class="action-buttons">
            <button class="btn-secondary" (click)="reiniciar()" [disabled]="cargando">
              <i class="fas fa-redo"></i> Limpiar
            </button>
            <button class="btn-primary" (click)="procesarArchivo()" 
                    [disabled]="!archivoSeleccionado || cargando">
              <span *ngIf="cargando" class="spinner"></span>
              <i *ngIf="!cargando" [class]="soloValidar ? 'fas fa-search' : 'fas fa-rocket'"></i>
              {{ cargando ? 'Procesando...' : (soloValidar ? 'Validar' : 'Procesar') }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resultados Compactos -->
    <div *ngIf="mostrarResultados && resultado" class="results-card">
      <div class="card-header">
        <h3><i class="fas fa-chart-bar"></i> Resultados</h3>
      </div>
      
      <div class="card-content">
        <!-- Stats Compactas -->
        <div class="stats-row">
          <div class="stat-item total">
            <i class="fas fa-list"></i>
            <div>
              <strong>{{ totalFilas }}</strong>
              <span>Total</span>
            </div>
          </div>
          <div class="stat-item valid" [class.active]="validos > 0">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>{{ validos }}</strong>
              <span>Válidos</span>
            </div>
          </div>
          <div class="stat-item invalid" [class.active]="invalidos > 0">
            <i class="fas fa-times-circle"></i>
            <div>
              <strong>{{ invalidos }}</strong>
              <span>Errores</span>
            </div>
          </div>
          <div class="stat-item warning" [class.active]="conAdvertencias > 0">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>{{ conAdvertencias }}</strong>
              <span>Advertencias</span>
            </div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
          <div class="progress-info">
            <span>Éxito: {{ obtenerPorcentajeValidos() }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" 
                 [style.width.%]="obtenerPorcentajeValidos()"
                 [ngClass]="'fill-' + obtenerClaseEstado(validos, invalidos)">
            </div>
          </div>
        </div>

        <!-- Empresas Creadas (Compacto) -->
        <div *ngIf="tieneEmpresasCreadas" class="section-compact">
          <div class="section-header" (click)="mostrarEmpresasCreadas = !mostrarEmpresasCreadas">
            <span><i class="fas fa-plus-circle"></i> Empresas Creadas ({{ resultadoProcesamiento?.empresas_creadas?.length }})</span>
            <i [class]="mostrarEmpresasCreadas ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
          </div>
          <div *ngIf="mostrarEmpresasCreadas" class="section-content">
            <div class="companies-list">
              <div *ngFor="let empresa of resultadoProcesamiento?.empresas_creadas" class="company-item">
                <div class="company-code">{{ empresa.codigo_empresa }}</div>
                <div class="company-details">
                  <strong>{{ empresa.razon_social }}</strong>
                  <small>RUC: {{ empresa.ruc }}</small>
                </div>
                <span class="badge success">{{ empresa.estado }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Errores (Compacto) -->
        <div *ngIf="tieneErrores" class="section-compact error-section">
          <div class="section-header" (click)="mostrarErrores = !mostrarErrores">
            <span><i class="fas fa-times-circle"></i> Errores ({{ errores.length }})</span>
            <i [class]="mostrarErrores ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
          </div>
          <div *ngIf="mostrarErrores" class="section-content">
            <div class="errors-list">
              <div *ngFor="let error of errores" class="error-item">
                <div class="error-header">
                  <span class="error-location">Fila {{ error.fila }} - {{ error.codigo_empresa }}</span>
                </div>
                <div class="error-messages">
                  <div *ngFor="let mensaje of error.errores" class="error-msg">
                    <i class="fas fa-chevron-right"></i>{{ mensaje }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Advertencias (Compacto) -->
        <div *ngIf="tieneAdvertencias" class="section-compact warning-section">
          <div class="section-header" (click)="mostrarAdvertencias = !mostrarAdvertencias">
            <span><i class="fas fa-exclamation-triangle"></i> Advertencias ({{ advertencias.length }})</span>
            <i [class]="mostrarAdvertencias ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
          </div>
          <div *ngIf="mostrarAdvertencias" class="section-content">
            <div class="warnings-list">
              <div *ngFor="let advertencia of advertencias" class="warning-item">
                <div class="warning-header">
                  <span class="warning-location">Fila {{ advertencia.fila }} - {{ advertencia.codigo_empresa }}</span>
                </div>
                <div class="warning-messages">
                  <div *ngFor="let mensaje of advertencia.advertencias" class="warning-msg">
                    <i class="fas fa-chevron-right"></i>{{ mensaje }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje de Éxito -->
        <div *ngIf="validos > 0 && invalidos === 0" class="success-banner">
          <i class="fas fa-check-circle"></i>
          <div>
            <strong>¡Procesamiento Exitoso!</strong>
            <p *ngIf="soloValidar">{{ validos }} empresas válidas listas para procesar.</p>
            <p *ngIf="!soloValidar">{{ resultadoProcesamiento?.total_creadas || 0 }} empresas creadas exitosamente.</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>