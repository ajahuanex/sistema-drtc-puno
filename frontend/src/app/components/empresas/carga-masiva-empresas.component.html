<div class="carga-masiva-container">
  <!-- Header -->
  <div class="header-section">
    <h2>üè¢ Carga Masiva de Empresas</h2>
    <p class="subtitle">Importa m√∫ltiples empresas desde un archivo Excel</p>
  </div>

  <!-- √Årea de mensajes -->
  <div *ngIf="mostrarMensajeFlag" [class]="obtenerClaseMensaje()" class="alert-dismissible fade show">
    {{ mensaje }}
    <button type="button" class="btn-close" (click)="ocultarMensaje()"></button>
  </div>

  <!-- Secci√≥n de Plantilla -->
  <div class="card plantilla-section">
    <div class="card-header">
      <h3>üìã Plantilla Excel</h3>
    </div>
    <div class="card-body">
      <p>Descarga la plantilla Excel con el formato correcto para cargar empresas:</p>
      <button 
        class="btn btn-outline-primary"
        (click)="descargarPlantilla()"
        [disabled]="cargando">
        <span *ngIf="cargando" class="spinner-border spinner-border-sm me-2"></span>
        üì• Descargar Plantilla
      </button>
    </div>
  </div>

  <!-- Secci√≥n de Carga -->
  <div class="card upload-section">
    <div class="card-header">
      <h3>üì§ Cargar Archivo</h3>
    </div>
    <div class="card-body">
      
      <!-- Selector de archivo -->
      <div class="mb-3">
        <label for="archivoInput" class="form-label">Seleccionar archivo Excel:</label>
        <input 
          type="file" 
          class="form-control" 
          id="archivoInput"
          accept=".xlsx,.xls"
          (change)="onArchivoSeleccionado($event)">
        <div class="form-text">Formatos soportados: .xlsx, .xls</div>
      </div>

      <!-- Opciones de procesamiento -->
      <div class="mb-3">
        <label class="form-label">Modo de operaci√≥n:</label>
        <div class="form-check">
          <input 
            class="form-check-input" 
            type="radio" 
            name="modoOperacion" 
            id="soloValidar"
            [value]="true"
            [checked]="soloValidar === true"
            (change)="soloValidar = true">
          <label class="form-check-label" for="soloValidar">
            üîç Solo validar (no crear empresas)
          </label>
        </div>
        <div class="form-check">
          <input 
            class="form-check-input" 
            type="radio" 
            name="modoOperacion" 
            id="procesarCompleto"
            [value]="false"
            [checked]="soloValidar === false"
            (change)="soloValidar = false">
          <label class="form-check-label" for="procesarCompleto">
            ‚úÖ Validar y crear empresas
          </label>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="d-flex gap-2 flex-wrap">
        <button 
          class="btn btn-primary"
          (click)="procesarArchivo()"
          [disabled]="!archivoSeleccionado || cargando">
          <span *ngIf="cargando" class="spinner-border spinner-border-sm me-2" role="status"></span>
          <span *ngIf="cargando">{{ soloValidar ? 'Validando...' : 'Procesando...' }}</span>
          <span *ngIf="!cargando">{{ soloValidar ? 'üîç Validar Archivo' : 'üöÄ Procesar Archivo' }}</span>
        </button>
        
        <button 
          class="btn btn-secondary"
          (click)="reiniciar()"
          [disabled]="cargando">
          üîÑ Reiniciar
        </button>
      </div>

      <!-- Informaci√≥n del archivo seleccionado -->
      <div *ngIf="archivoSeleccionado" class="mt-3 p-3 bg-light rounded border">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <i class="fas fa-file-excel text-success" style="font-size: 2rem;"></i>
          </div>
          <div class="flex-grow-1">
            <div class="fw-bold">{{ archivoSeleccionado.name }}</div>
            <div class="text-muted small">
              Tama√±o: {{ (archivoSeleccionado.size / 1024).toFixed(2) }} KB
              <span class="ms-2">‚Ä¢</span>
              Tipo: {{ archivoSeleccionado.type || 'Excel' }}
            </div>
          </div>
          <div>
            <span class="badge bg-success">‚úì Listo</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados -->
  <div *ngIf="mostrarResultados && resultado" class="card results-section">
    <div class="card-header">
      <h3>üìä Resultados del Procesamiento</h3>
    </div>
    <div class="card-body">
      
      <!-- Resumen general -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card text-center p-3 border rounded">
            <div class="stat-number">{{ totalFilas }}</div>
            <div class="stat-label">Total Filas</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 border rounded bg-success text-white">
            <div class="stat-number">{{ validos }}</div>
            <div class="stat-label">V√°lidos</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 border rounded bg-danger text-white">
            <div class="stat-number">{{ invalidos }}</div>
            <div class="stat-label">Inv√°lidos</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center p-3 border rounded bg-warning text-white">
            <div class="stat-number">{{ conAdvertencias }}</div>
            <div class="stat-label">Con Advertencias</div>
          </div>
        </div>
      </div>

      <!-- Barra de progreso -->
      <div class="mb-4">
        <div class="d-flex justify-content-between mb-1">
          <span>Porcentaje de √©xito</span>
          <span>{{ obtenerPorcentajeValidos() }}%</span>
        </div>
        <div class="progress">
          <div 
            class="progress-bar"
            [class]="'bg-' + obtenerClaseEstado(validos, invalidos)"
            [style.width.%]="obtenerPorcentajeValidos()">
          </div>
        </div>
      </div>

      <!-- Empresas creadas (solo en modo procesamiento) -->
      <div *ngIf="tieneEmpresasCreadas" class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">‚úÖ Empresas Creadas ({{ resultadoProcesamiento?.empresas_creadas?.length || 0 }})</h5>
          <button 
            class="btn btn-sm btn-outline-secondary"
            (click)="mostrarEmpresasCreadas = !mostrarEmpresasCreadas">
            {{ mostrarEmpresasCreadas ? 'Ocultar' : 'Mostrar' }}
          </button>
        </div>
        
        <div *ngIf="mostrarEmpresasCreadas" class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>RUC</th>
                <th>Raz√≥n Social</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let empresa of resultadoProcesamiento?.empresas_creadas">
                <td><code>{{ empresa.codigo_empresa }}</code></td>
                <td>{{ empresa.ruc }}</td>
                <td>{{ empresa.razon_social }}</td>
                <td>
                  <span class="badge bg-success">{{ empresa.estado }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Errores -->
      <div *ngIf="tieneErrores" class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0 text-danger">‚ùå Errores ({{ errores.length }})</h5>
          <button 
            class="btn btn-sm btn-outline-secondary"
            (click)="mostrarErrores = !mostrarErrores">
            {{ mostrarErrores ? 'Ocultar' : 'Mostrar' }}
          </button>
        </div>
        
        <div *ngIf="mostrarErrores" class="error-list">
          <div *ngFor="let error of errores" class="alert alert-danger">
            <strong>Fila {{ error.fila }} - C√≥digo: {{ error.codigo_empresa }}</strong>
            <ul class="mb-0 mt-2">
              <li *ngFor="let mensaje of error.errores">{{ mensaje }}</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Advertencias -->
      <div *ngIf="tieneAdvertencias" class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0 text-warning">‚ö†Ô∏è Advertencias ({{ advertencias.length }})</h5>
          <button 
            class="btn btn-sm btn-outline-secondary"
            (click)="mostrarAdvertencias = !mostrarAdvertencias">
            {{ mostrarAdvertencias ? 'Ocultar' : 'Mostrar' }}
          </button>
        </div>
        
        <div *ngIf="mostrarAdvertencias" class="warning-list">
          <div *ngFor="let advertencia of advertencias" class="alert alert-warning">
            <strong>Fila {{ advertencia.fila }} - C√≥digo: {{ advertencia.codigo_empresa }}</strong>
            <ul class="mb-0 mt-2">
              <li *ngFor="let mensaje of advertencia.advertencias">{{ mensaje }}</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Mensaje de √©xito -->
      <div *ngIf="validos > 0 && invalidos === 0" class="alert alert-success">
        <strong>üéâ ¬°Procesamiento exitoso!</strong>
        <br>
        <span *ngIf="soloValidar">
          Todas las {{ validos }} empresas son v√°lidas y est√°n listas para ser procesadas.
        </span>
        <span *ngIf="!soloValidar && esResultadoProcesamiento">
          Se crearon {{ resultadoProcesamiento?.total_creadas || 0 }} empresas exitosamente.
        </span>
      </div>

    </div>
  </div>

</div>