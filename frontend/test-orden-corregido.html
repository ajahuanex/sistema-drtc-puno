<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Test - Orden Corregido</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .button { background: #1976d2; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; }
        .button:hover { background: #1565c0; }
        .success { background: #e8f5e8; color: #2e7d32; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; color: #f57c00; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ff9800; }
        .info { background: #e3f2fd; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #2196f3; }
        .orden-box { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .columna { display: inline-block; margin: 2px; padding: 4px 8px; background: #e0e0e0; border-radius: 3px; font-size: 11px; }
        .match { background: #c8e6c8; }
        .no-match { background: #ffcdd2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Verificaci√≥n Final - Orden Corregido</h1>
        
        <div class="warning">
            <h3>üîß Problema Identificado y Solucionado:</h3>
            <p><strong>Causa:</strong> El servicio Angular estaba descargando desde el backend (que tiene orden antiguo)</p>
            <p><strong>Soluci√≥n:</strong> Modificado para usar directamente la plantilla local con orden correcto</p>
        </div>

        <div class="info">
            <h3>üìã Orden Requerido (36 columnas):</h3>
            <div class="orden-box">
RUC Empresa,Resoluci√≥n Primigenia,DNI,Resoluci√≥n Hija,Fecha Resoluci√≥n,Tipo de Resoluci√≥n,Placa de Baja,Placa,Marca,Modelo,A√±o Fabricaci√≥n,Color,Categor√≠a,Carroceria,Tipo Combustible,Motor,N√∫mero Serie VIN,Numero de pasajeros,Asientos,Cilindros,Ejes,Ruedas,Peso Bruto (t),Peso Neto (t),Carga √ötil (t),Largo (m),Ancho (m),Alto (m),Cilindrada,Potencia (HP),Estado,Observaciones,Sede de Registro,Expediente,TUC,Rutas Asignadas
            </div>
        </div>

        <button class="button" onclick="generarPlantillaCorregida()">
            üì• Generar Plantilla con Orden Corregido
        </button>

        <div id="resultado"></div>
    </div>

    <script>
        // Orden exacto requerido
        const ordenRequerido = [
            'RUC Empresa', 'Resoluci√≥n Primigenia', 'DNI', 'Resoluci√≥n Hija', 'Fecha Resoluci√≥n',
            'Tipo de Resoluci√≥n', 'Placa de Baja', 'Placa', 'Marca', 'Modelo', 'A√±o Fabricaci√≥n',
            'Color', 'Categor√≠a', 'Carroceria', 'Tipo Combustible', 'Motor', 'N√∫mero Serie VIN',
            'Numero de pasajeros', 'Asientos', 'Cilindros', 'Ejes', 'Ruedas', 'Peso Bruto (t)',
            'Peso Neto (t)', 'Carga √ötil (t)', 'Largo (m)', 'Ancho (m)', 'Alto (m)', 'Cilindrada',
            'Potencia (HP)', 'Estado', 'Observaciones', 'Sede de Registro', 'Expediente', 'TUC', 'Rutas Asignadas'
        ];

        function generarPlantillaCorregida() {
            try {
                console.log('üöÄ Generando plantilla con orden CORREGIDO...');
                
                // Crear workbook
                const workbook = XLSX.utils.book_new();
                
                // Usar EXACTAMENTE el orden requerido
                const columnas = [
                    { campo: 'RUC Empresa', descripcion: 'RUC de la empresa transportista (11 d√≠gitos)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Resoluci√≥n Primigenia', descripcion: 'N√∫mero de resoluci√≥n primigenia (Ej: R-0123-2025 o 0123-2025)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'DNI', descripcion: 'DNI del propietario (8 d√≠gitos)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Resoluci√≥n Hija', descripcion: 'N√∫mero de resoluci√≥n hija (Ej: R-0124-2025 o 0124-2025)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Fecha Resoluci√≥n', descripcion: 'Fecha de la resoluci√≥n (DD/MM/AAAA)', obligatorio: 'NO', tipo: 'Fecha' },
                    { campo: 'Tipo de Resoluci√≥n', descripcion: 'Tipo de resoluci√≥n (Autorizaci√≥n, Modificaci√≥n, etc.)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Placa de Baja', descripcion: 'Placa del veh√≠culo dado de baja (si aplica)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Placa', descripcion: 'Placa del veh√≠culo (Ej: ABC-123)', obligatorio: 'S√ç', tipo: 'Texto' },
                    { campo: 'Marca', descripcion: 'Marca del veh√≠culo', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Modelo', descripcion: 'Modelo del veh√≠culo', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'A√±o Fabricaci√≥n', descripcion: 'A√±o de fabricaci√≥n (1990-2026)', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Color', descripcion: 'Color del veh√≠culo', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Categor√≠a', descripcion: 'Categor√≠a (M1, M2, M3, N1, N2, N3)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Carroceria', descripcion: 'Tipo de carrocer√≠a', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Tipo Combustible', descripcion: 'Tipo de combustible (Gasolina, Diesel, GLP, etc.)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Motor', descripcion: 'N√∫mero de motor', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'N√∫mero Serie VIN', descripcion: 'N√∫mero de serie VIN del veh√≠culo', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Numero de pasajeros', descripcion: 'N√∫mero total de pasajeros (1-100)', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Asientos', descripcion: 'N√∫mero de asientos (1-100)', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Cilindros', descripcion: 'N√∫mero de cilindros del motor', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Ejes', descripcion: 'N√∫mero de ejes del veh√≠culo', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Ruedas', descripcion: 'N√∫mero de ruedas del veh√≠culo', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Peso Bruto (t)', descripcion: 'Peso bruto en toneladas', obligatorio: 'NO', tipo: 'Decimal' },
                    { campo: 'Peso Neto (t)', descripcion: 'Peso neto en toneladas', obligatorio: 'NO', tipo: 'Decimal' },
                    { campo: 'Carga √ötil (t)', descripcion: 'Carga √∫til en toneladas (se calcula autom√°ticamente)', obligatorio: 'NO', tipo: 'Decimal' },
                    { campo: 'Largo (m)', descripcion: 'Largo del veh√≠culo en metros', obligatorio: 'NO', tipo: 'Decimal' },
                    { campo: 'Ancho (m)', descripcion: 'Ancho del veh√≠culo en metros', obligatorio: 'NO', tipo: 'Decimal' },
                    { campo: 'Alto (m)', descripcion: 'Alto del veh√≠culo en metros', obligatorio: 'NO', tipo: 'Decimal' },
                    { campo: 'Cilindrada', descripcion: 'Cilindrada del motor en cc', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Potencia (HP)', descripcion: 'Potencia del motor en caballos de fuerza', obligatorio: 'NO', tipo: 'N√∫mero' },
                    { campo: 'Estado', descripcion: 'Estado del veh√≠culo (ACTIVO, INACTIVO, etc.)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Observaciones', descripcion: 'Observaciones adicionales del veh√≠culo', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Sede de Registro', descripcion: 'Sede donde se registra el veh√≠culo', obligatorio: 'S√ç', tipo: 'Texto' },
                    { campo: 'Expediente', descripcion: 'N√∫mero de expediente (Ej: E-01234-2025 o 01234-2025)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'TUC', descripcion: 'N√∫mero de TUC (Ej: T-123456-2024 o 123456 o 123)', obligatorio: 'NO', tipo: 'Texto' },
                    { campo: 'Rutas Asignadas', descripcion: 'Rutas asignadas (formato: 1 o 01 o 01,02,03)', obligatorio: 'NO', tipo: 'Texto' }
                ];

                // Verificar que el orden sea correcto
                const headers = columnas.map(col => col.campo);
                let ordenCorrecto = true;
                let diferencias = [];
                
                for (let i = 0; i < ordenRequerido.length; i++) {
                    if (ordenRequerido[i] !== headers[i]) {
                        ordenCorrecto = false;
                        diferencias.push({
                            posicion: i + 1,
                            requerido: ordenRequerido[i],
                            actual: headers[i]
                        });
                    }
                }

                console.log(`üìä Orden correcto: ${ordenCorrecto}`);
                console.log(`üìã Headers generados: ${headers.length}`);

                // Ejemplos con formatos flexibles
                const ejemplos = {
                    'RUC Empresa': '20123456789',
                    'Resoluci√≥n Primigenia': '0123-2025',
                    'DNI': '12345678',
                    'Resoluci√≥n Hija': '0124-2025',
                    'Fecha Resoluci√≥n': '15/01/2024',
                    'Tipo de Resoluci√≥n': 'Autorizaci√≥n',
                    'Placa de Baja': 'XYZ-789',
                    'Placa': 'ABC-123',
                    'Marca': 'MERCEDES BENZ',
                    'Modelo': 'SPRINTER',
                    'A√±o Fabricaci√≥n': '2020',
                    'Color': 'BLANCO',
                    'Categor√≠a': 'M3',
                    'Carroceria': 'MINIBUS',
                    'Tipo Combustible': 'DIESEL',
                    'Motor': 'MB123456789',
                    'N√∫mero Serie VIN': 'VIN123456789',
                    'Numero de pasajeros': '20',
                    'Asientos': '20',
                    'Cilindros': '4',
                    'Ejes': '2',
                    'Ruedas': '6',
                    'Peso Bruto (t)': '5.5',
                    'Peso Neto (t)': '3.5',
                    'Carga √ötil (t)': '2.0',
                    'Largo (m)': '8.5',
                    'Ancho (m)': '2.4',
                    'Alto (m)': '2.8',
                    'Cilindrada': '2400',
                    'Potencia (HP)': '150',
                    'Estado': 'ACTIVO',
                    'Observaciones': 'Veh√≠culo en buen estado',
                    'Sede de Registro': 'LIMA',
                    'Expediente': '01234-2025',
                    'TUC': '123456',
                    'Rutas Asignadas': '01,02,03'
                };

                // Hoja 1: Instrucciones
                const instrucciones = [
                    ['PLANTILLA DE CARGA MASIVA DE VEH√çCULOS - SIRRET'],
                    ['Sistema Integral de Registros y Regulaci√≥n de Empresas de Transporte'],
                    [''],
                    ['‚úÖ PROBLEMA SOLUCIONADO - ORDEN CORREGIDO'],
                    ['Las 36 columnas est√°n ahora en el orden exacto requerido'],
                    ['El servicio Angular usa directamente la plantilla local actualizada'],
                    [''],
                    ['FORMATOS FLEXIBLES:'],
                    ['‚Ä¢ Resoluciones: R-0123-2025 o 0123-2025 (prefijo opcional)'],
                    ['‚Ä¢ Expediente: E-01234-2025 o 01234-2025 (prefijo opcional)'],
                    ['‚Ä¢ TUC: T-123456 o 123456 o 123 (se completa a 6 d√≠gitos)'],
                    ['‚Ä¢ Rutas: 1 o 01 o 01,02,03'],
                    [''],
                    ['CAMPOS OBLIGATORIOS:'],
                    ['‚Ä¢ Placa (posici√≥n 8)'],
                    ['‚Ä¢ Sede de Registro (posici√≥n 33)'],
                    [''],
                    ['Total de campos: ' + headers.length],
                    ['Orden correcto: ' + (ordenCorrecto ? 'S√ç' : 'NO')],
                    ['Fecha: ' + new Date().toLocaleDateString('es-PE')]
                ];

                const wsInstrucciones = XLSX.utils.aoa_to_sheet(instrucciones);
                XLSX.utils.book_append_sheet(workbook, wsInstrucciones, 'INSTRUCCIONES');

                // Hoja 2: Referencia
                const referencia = [
                    ['POSICI√ìN', 'CAMPO', 'EJEMPLO', 'OBLIGATORIO', 'TIPO'],
                    ...columnas.map((col, index) => [
                        index + 1,
                        col.campo,
                        ejemplos[col.campo] || '',
                        col.obligatorio,
                        col.tipo
                    ])
                ];

                const wsReferencia = XLSX.utils.aoa_to_sheet(referencia);
                XLSX.utils.book_append_sheet(workbook, wsReferencia, 'REFERENCIA');

                // Hoja 3: Datos
                const filaVacia = new Array(36).fill('');
                const datosPlanilla = [
                    headers, // Headers en orden correcto
                    [...filaVacia],
                    [...filaVacia],
                    [...filaVacia],
                    [...filaVacia],
                    [...filaVacia]
                ];

                const wsDatos = XLSX.utils.aoa_to_sheet(datosPlanilla);
                
                // Aplicar estilos a headers
                const range = XLSX.utils.decode_range(wsDatos['!ref'] || 'A1');
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (wsDatos[cellAddress]) {
                        wsDatos[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "1976D2" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                }

                // Ancho de columnas
                wsDatos['!cols'] = headers.map(() => ({ width: 15 }));

                XLSX.utils.book_append_sheet(workbook, wsDatos, 'DATOS');

                // Generar archivo
                const fecha = new Date().toISOString().split('T')[0];
                const nombreArchivo = `plantilla_vehiculos_CORREGIDA_${fecha}.xlsx`;
                
                XLSX.writeFile(workbook, nombreArchivo);
                
                // Mostrar resultado
                let html = `
                    <div class="${ordenCorrecto ? 'success' : 'warning'}">
                        <h3>${ordenCorrecto ? '‚úÖ ¬°ORDEN PERFECTO - PROBLEMA SOLUCIONADO!' : '‚ö†Ô∏è A√∫n hay diferencias'}</h3>
                        <p><strong>Archivo generado:</strong> ${nombreArchivo}</p>
                        <p><strong>Total de columnas:</strong> ${headers.length}</p>
                        <p><strong>Orden correcto:</strong> ${ordenCorrecto ? 'S√ç' : 'NO'}</p>
                        <p><strong>Cambio realizado:</strong> Servicio Angular usa plantilla local directamente</p>
                `;
                
                if (ordenCorrecto) {
                    html += `
                        <p><strong>‚úÖ Verificaci√≥n:</strong> Las 36 columnas est√°n en el orden exacto requerido</p>
                        <p><strong>‚úÖ Formatos:</strong> Flexibles (con y sin prefijos)</p>
                        <p><strong>‚úÖ Hojas:</strong> INSTRUCCIONES, REFERENCIA, DATOS</p>
                        <p><strong>‚úÖ Soluci√≥n:</strong> Ya no depende del backend desactualizado</p>
                    `;
                } else {
                    html += `<p><strong>‚ùå Diferencias encontradas:</strong> ${diferencias.length}</p>`;
                    diferencias.forEach(diff => {
                        html += `<br>‚Ä¢ Posici√≥n ${diff.posicion}: "${diff.requerido}" ‚â† "${diff.actual}"`;
                    });
                }
                
                html += `</div>`;
                
                // Mostrar comparaci√≥n visual
                html += `
                    <div class="info">
                        <h3>üìä Orden Generado (Verificaci√≥n Visual):</h3>
                        <div>
                `;
                
                headers.forEach((campo, index) => {
                    const esCorrecta = ordenRequerido[index] === campo;
                    html += `<span class="columna ${esCorrecta ? 'match' : 'no-match'}">${index + 1}. ${campo}</span>`;
                });
                
                html += `
                        </div>
                        <small>Verde = Correcto, Rojo = Incorrecto</small>
                    </div>
                `;
                
                document.getElementById('resultado').innerHTML = html;
                
                console.log(`‚úÖ Plantilla generada: ${nombreArchivo}`);
                console.log(`üìä Orden correcto: ${ordenCorrecto}`);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('resultado').innerHTML = `
                    <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>