<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test - Validaci√≥n Corregida</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .button { background: #1976d2; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; }
        .button:hover { background: #1565c0; }
        .success { background: #e8f5e8; color: #2e7d32; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; color: #f57c00; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ff9800; }
        .error { background: #ffebee; color: #c62828; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #f44336; }
        .info { background: #e3f2fd; padding: 20px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #2196f3; }
        .mapeo { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .test-data { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 11px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test - Validaci√≥n Corregida para Nuevo Orden</h1>
        
        <div class="error">
            <h3>üêõ Problema Identificado:</h3>
            <p><strong>Causa:</strong> La validaci√≥n estaba usando el mapeo de columnas del orden ANTIGUO</p>
            <p><strong>S√≠ntoma:</strong> Interpretaba RUC como placa, marca como asientos, etc.</p>
            <p><strong>Soluci√≥n:</strong> Actualizado el mapeo para el nuevo orden de 36 columnas</p>
        </div>

        <div class="info">
            <h3>üìã Mapeo Corregido de Columnas:</h3>
            <div class="mapeo">
<strong>ANTES (Incorrecto):</strong>
‚Ä¢ Placa: posici√≥n 0 ‚ùå (era RUC Empresa)
‚Ä¢ Marca: posici√≥n 1 ‚ùå (era Resoluci√≥n Primigenia)  
‚Ä¢ Sede: posici√≥n 22 ‚ùå (era Peso Bruto)

<strong>AHORA (Correcto):</strong>
‚Ä¢ RUC Empresa: posici√≥n 0 ‚úÖ
‚Ä¢ Placa: posici√≥n 7 ‚úÖ
‚Ä¢ Marca: posici√≥n 8 ‚úÖ
‚Ä¢ Sede de Registro: posici√≥n 32 ‚úÖ
            </div>
        </div>

        <button class="button" onclick="generarArchivoTest()">
            üì• Generar Archivo de Test con Datos V√°lidos
        </button>

        <button class="button" onclick="simularValidacion()">
            üîç Simular Validaci√≥n con Nuevo Mapeo
        </button>

        <div id="resultado"></div>
    </div>

    <script>
        // Datos de prueba con el orden correcto
        const datosTest = [
            // Headers (36 columnas)
            ['RUC Empresa', 'Resoluci√≥n Primigenia', 'DNI', 'Resoluci√≥n Hija', 'Fecha Resoluci√≥n', 'Tipo de Resoluci√≥n', 'Placa de Baja', 'Placa', 'Marca', 'Modelo', 'A√±o Fabricaci√≥n', 'Color', 'Categor√≠a', 'Carroceria', 'Tipo Combustible', 'Motor', 'N√∫mero Serie VIN', 'Numero de pasajeros', 'Asientos', 'Cilindros', 'Ejes', 'Ruedas', 'Peso Bruto (t)', 'Peso Neto (t)', 'Carga √ötil (t)', 'Largo (m)', 'Ancho (m)', 'Alto (m)', 'Cilindrada', 'Potencia (HP)', 'Estado', 'Observaciones', 'Sede de Registro', 'Expediente', 'TUC', 'Rutas Asignadas'],
            
            // Datos v√°lidos
            ['20123456789', '0123-2025', '12345678', '0124-2025', '15/01/2024', 'Autorizaci√≥n', '', 'ABC-123', 'MERCEDES BENZ', 'SPRINTER', '2020', 'BLANCO', 'M3', 'MINIBUS', 'DIESEL', 'MB123456789', 'VIN123456789', '20', '20', '4', '2', '6', '5.5', '3.5', '2.0', '8.5', '2.4', '2.8', '2400', '150', 'ACTIVO', 'Veh√≠culo en buen estado', 'LIMA', '01234-2025', '123456', '01,02,03'],
            
            // Datos con errores para probar validaci√≥n
            ['20987654321', '0125-2025', '87654321', '0126-2025', '20/01/2024', 'Modificaci√≥n', '', 'DEF456', 'TOYOTA', 'HIACE', '2050', 'AZUL', 'M2', 'MINIBUS', 'GASOLINA', 'TY987654321', 'VIN987654321', '150', '150', '4', '2', '4', '4.2', '2.8', '1.4', '6.2', '1.9', '2.3', '2000', '120', 'ACTIVO', 'Veh√≠culo con errores', 'AREQUIPA', '01235-2025', 'INVALID', '02,04'],
            
            // Solo campos obligatorios
            ['', '', '', '', '', '', '', 'GHI-789', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'CUSCO', '', '', '']
        ];

        function generarArchivoTest() {
            try {
                console.log('üì• Generando archivo de test...');
                
                const workbook = XLSX.utils.book_new();
                
                // Crear hoja con datos de test
                const ws = XLSX.utils.aoa_to_sheet(datosTest);
                
                // Aplicar estilos a headers
                const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "1976D2" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                }

                // Ancho de columnas
                ws['!cols'] = datosTest[0].map(() => ({ width: 12 }));

                XLSX.utils.book_append_sheet(workbook, ws, 'DATOS');

                // Generar archivo
                const fecha = new Date().toISOString().split('T')[0];
                const nombreArchivo = `test_validacion_corregida_${fecha}.xlsx`;
                
                XLSX.writeFile(workbook, nombreArchivo);
                
                document.getElementById('resultado').innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Archivo de Test Generado</h3>
                        <p><strong>Archivo:</strong> ${nombreArchivo}</p>
                        <p><strong>Contenido:</strong></p>
                        <ul>
                            <li>1 fila de headers (36 columnas en orden correcto)</li>
                            <li>1 registro v√°lido completo</li>
                            <li>1 registro con errores intencionados</li>
                            <li>1 registro solo con campos obligatorios</li>
                        </ul>
                        <p><strong>Uso:</strong> Sube este archivo al sistema para probar la validaci√≥n corregida</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('resultado').innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        function simularValidacion() {
            console.log('üîç Simulando validaci√≥n...');
            
            const resultados = [];
            
            // Simular validaci√≥n de cada fila (saltando headers)
            for (let i = 1; i < datosTest.length; i++) {
                const row = datosTest[i];
                
                // Mapeo correcto seg√∫n el nuevo orden
                const rucEmpresa = row[0] || '';
                const resolucionPrimigenia = row[1] || '';
                const dni = row[2] || '';
                const resolucionHija = row[3] || '';
                const fechaResolucion = row[4] || '';
                const tipoResolucion = row[5] || '';
                const placaBaja = row[6] || '';
                const placa = row[7] || '';  // Posici√≥n 7 - OBLIGATORIO
                const marca = row[8] || '';
                const modelo = row[9] || '';
                const anioStr = row[10] || '';
                const color = row[11] || '';
                const categoria = row[12] || '';
                const carroceria = row[13] || '';
                const tipoCombustible = row[14] || '';
                const motor = row[15] || '';
                const numeroSerieVIN = row[16] || '';
                const numeroPasajeros = row[17] || '';
                const asientosStr = row[18] || '';
                const cilindros = row[19] || '';
                const ejes = row[20] || '';
                const ruedas = row[21] || '';
                const pesoBruto = row[22] || '';
                const pesoNeto = row[23] || '';
                const cargaUtil = row[24] || '';
                const largo = row[25] || '';
                const ancho = row[26] || '';
                const alto = row[27] || '';
                const cilindrada = row[28] || '';
                const potencia = row[29] || '';
                const estado = row[30] || '';
                const observaciones = row[31] || '';
                const sedeRegistro = row[32] || '';  // Posici√≥n 32 - OBLIGATORIO
                const expediente = row[33] || '';
                const tuc = row[34] || '';
                const rutasAsignadas = row[35] || '';
                
                const validacion = {
                    fila: i + 1,
                    placa: placa,
                    valido: true,
                    errores: [],
                    advertencias: []
                };

                // Validaciones
                if (!placa) {
                    validacion.valido = false;
                    validacion.errores.push('Placa es obligatoria');
                } else {
                    const placaRegex = /^[A-Z0-9]{1,3}-[0-9]{3}$/;
                    if (!placaRegex.test(placa)) {
                        validacion.valido = false;
                        validacion.errores.push('Formato de placa inv√°lido (use ABC-123)');
                    }
                }

                if (!sedeRegistro) {
                    validacion.valido = false;
                    validacion.errores.push('Sede de registro es obligatoria');
                }

                // Validar a√±o
                if (anioStr) {
                    const anio = parseInt(anioStr);
                    if (isNaN(anio) || anio < 1990 || anio > new Date().getFullYear() + 1) {
                        validacion.valido = false;
                        validacion.errores.push(`A√±o inv√°lido: ${anioStr}`);
                    }
                }

                // Validar asientos
                if (asientosStr) {
                    const asientos = parseInt(asientosStr);
                    if (isNaN(asientos) || asientos < 1 || asientos > 100) {
                        validacion.valido = false;
                        validacion.errores.push(`Asientos inv√°lidos: ${asientosStr}`);
                    }
                }

                // Validar RUC
                if (rucEmpresa && !/^\d{11}$/.test(rucEmpresa)) {
                    validacion.valido = false;
                    validacion.errores.push(`RUC inv√°lido: ${rucEmpresa}`);
                }

                // Validar DNI
                if (dni && !/^\d{8}$/.test(dni)) {
                    validacion.valido = false;
                    validacion.errores.push(`DNI inv√°lido: ${dni}`);
                }

                if (validacion.errores.length === 0) {
                    validacion.advertencias.push('Registro v√°lido');
                }

                resultados.push(validacion);
            }
            
            // Mostrar resultados
            let html = `
                <div class="success">
                    <h3>üîç Simulaci√≥n de Validaci√≥n Completada</h3>
                    <p><strong>Registros procesados:</strong> ${resultados.length}</p>
                    <p><strong>V√°lidos:</strong> ${resultados.filter(r => r.valido).length}</p>
                    <p><strong>Con errores:</strong> ${resultados.filter(r => !r.valido).length}</p>
                </div>
                
                <div class="info">
                    <h3>üìä Resultados Detallados:</h3>
            `;
            
            resultados.forEach(r => {
                html += `
                    <div class="test-data">
                        <strong>Fila ${r.fila} - Placa: ${r.placa}</strong> 
                        ${r.valido ? '‚úÖ V√ÅLIDO' : '‚ùå ERROR'}
                        ${r.errores.length > 0 ? '<br>Errores: ' + r.errores.join(', ') : ''}
                        ${r.advertencias.length > 0 ? '<br>Advertencias: ' + r.advertencias.join(', ') : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            document.getElementById('resultado').innerHTML = html;
        }
    </script>
</body>
</html>